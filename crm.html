<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>pracmatik. CRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --purple: #8b5cf6;
            --pink: #ec4899;
            --cyan: #06b6d4;
        }

        .dark {
            --bg-main: #030712;
            --bg-depth: #0a0f1a;
            --bg-card: rgba(15, 23, 42, 0.85);
            --bg-glass: rgba(255, 255, 255, 0.03);
            --text: #f1f5f9;
            --text-muted: #64748b;
            --border: rgba(148, 163, 184, 0.15);
        }

        .light {
            --bg-main: #f8fafc;
            --bg-depth: #e2e8f0;
            --bg-card: rgba(255, 255, 255, 0.9);
            --bg-glass: rgba(0, 0, 0, 0.02);
            --text: #0f172a;
            --text-muted: #475569;
            --border: rgba(0, 0, 0, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-main);
            min-height: 100vh;
            color: var(--text);
            overflow-x: hidden;
        }

        /* Deep Background */
        .bg-universe {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            background: radial-gradient(ellipse at 50% 0%, rgba(99, 102, 241, 0.15) 0%, transparent 50%), radial-gradient(ellipse at 80% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 40%), radial-gradient(ellipse at 20% 90%, rgba(16, 185, 129, 0.1) 0%, transparent 40%);
        }

        .stars {
            position: absolute;
            inset: 0;
            background-image: radial-gradient(2px 2px at 20px 30px, rgba(255, 255, 255, 0.3), transparent), radial-gradient(2px 2px at 40px 70px, rgba(255, 255, 255, 0.2), transparent), radial-gradient(1px 1px at 90px 40px, rgba(255, 255, 255, 0.4), transparent), radial-gradient(2px 2px at 130px 80px, rgba(255, 255, 255, 0.2), transparent), radial-gradient(1px 1px at 160px 120px, rgba(255, 255, 255, 0.3), transparent);
            background-size: 200px 200px;
            animation: twinkle 8s ease-in-out infinite;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }
        }

        .light .stars {
            opacity: 0;
        }

        .nebula {
            position: absolute;
            width: 800px;
            height: 800px;
            border-radius: 50%;
            filter: blur(150px);
            opacity: 0.4;
            animation: drift 30s ease-in-out infinite;
        }

        .nebula.n1 {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            top: -300px;
            left: -200px;
        }

        .nebula.n2 {
            background: linear-gradient(135deg, var(--pink), var(--danger));
            bottom: -300px;
            right: -200px;
            animation-delay: -10s;
        }

        .nebula.n3 {
            background: linear-gradient(135deg, var(--success), var(--cyan));
            top: 40%;
            left: 50%;
            width: 500px;
            height: 500px;
            animation-delay: -20s;
        }

        @keyframes drift {

            0%,
            100% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }

            33% {
                transform: translate(30px, -30px) scale(1.1) rotate(5deg);
            }

            66% {
                transform: translate(-20px, 20px) scale(0.95) rotate(-3deg);
            }
        }

        .light .nebula {
            opacity: 0.1;
        }

        .grid-lines {
            position: absolute;
            inset: 0;
            background-image: linear-gradient(rgba(99, 102, 241, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(99, 102, 241, 0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            animation: gridMove 20s linear infinite;
        }

        @keyframes gridMove {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(60px, 60px);
            }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Brand Header */
        .brand-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0 30px;
            animation: fadeDown 0.6s ease;
        }

        @keyframes fadeDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
        }

        .brand {
            display: flex;
            align-items: baseline;
            gap: 2px;
        }

        .brand-name {
            font-size: clamp(28px, 6vw, 42px);
            font-weight: 900;
            letter-spacing: -2px;
            background: linear-gradient(135deg, #fff 0%, rgba(255, 255, 255, 0.7) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .light .brand-name {
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            -webkit-background-clip: text;
            background-clip: text;
        }

        .brand-dot {
            font-size: clamp(28px, 6vw, 42px);
            font-weight: 900;
            color: var(--primary);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--bg-glass);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .icon-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .time-display {
            font-size: 13px;
            color: var(--text-muted);
            text-align: right;
        }

        .time-display .time {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }

        /* Section Overview Grid */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .overview-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 600px) {
            .overview-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .section-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            animation: cardIn 0.5s ease calc(var(--i, 0) * 0.08s) both;
            text-decoration: none;
            color: var(--text);
            display: block;
        }

        @keyframes cardIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
        }

        .section-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--card-accent, var(--primary));
            transform: scaleX(0);
            transition: transform 0.3s;
            transform-origin: left;
        }

        .section-card:hover::before {
            transform: scaleX(1);
        }

        .section-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4), 0 0 0 1px var(--card-accent, var(--primary));
        }

        .section-icon {
            font-size: 36px;
            margin-bottom: 12px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .section-value {
            font-size: 32px;
            font-weight: 900;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--card-accent, var(--primary)), var(--text));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .section-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-mini-chart {
            height: 40px;
            margin-top: 12px;
            display: flex;
            align-items: flex-end;
            gap: 3px;
        }

        .mini-bar {
            flex: 1;
            background: var(--card-accent, var(--primary));
            border-radius: 3px 3px 0 0;
            opacity: 0.6;
            transition: opacity 0.2s;
            animation: barGrow 0.5s ease calc(var(--b, 0) * 0.05s) both;
        }

        @keyframes barGrow {
            from {
                height: 0 !important;
            }
        }

        .section-card:hover .mini-bar {
            opacity: 1;
        }

        .status-ring {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 50px;
            height: 50px;
        }

        .ring-bg {
            fill: none;
            stroke: var(--bg-glass);
            stroke-width: 4;
        }

        .ring-progress {
            fill: none;
            stroke: var(--card-accent, var(--primary));
            stroke-width: 4;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: center;
            transition: stroke-dashoffset 1s ease;
        }

        /* Main Dashboard Grid */
        .dashboard-main {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1000px) {
            .dashboard-main {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 24px;
            animation: fadeUp 0.6s ease 0.3s both;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-link {
            font-size: 12px;
            color: var(--primary-light);
            text-decoration: none;
            padding: 6px 12px;
            background: var(--bg-glass);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .panel-link:hover {
            background: var(--primary);
            color: white;
        }

        /* Chart */
        .chart-wrapper {
            height: 280px;
            position: relative;
        }

        /* Activity Feed */
        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            gap: 12px;
            padding: 14px;
            background: var(--bg-glass);
            border-radius: 14px;
            transition: all 0.3s;
            cursor: pointer;
            animation: slideIn 0.4s ease calc(var(--i, 0) * 0.05s) both;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
        }

        .activity-item:hover {
            background: rgba(99, 102, 241, 0.1);
            transform: translateX(5px);
        }

        .activity-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .activity-icon.success {
            background: rgba(16, 185, 129, 0.2);
        }

        .activity-icon.warning {
            background: rgba(245, 158, 11, 0.2);
        }

        .activity-icon.info {
            background: rgba(59, 130, 246, 0.2);
        }

        .activity-icon.danger {
            background: rgba(239, 68, 68, 0.2);
        }

        .activity-icon.purple {
            background: rgba(139, 92, 246, 0.2);
        }

        .activity-icon.pink {
            background: rgba(236, 72, 153, 0.2);
        }

        .activity-content {
            flex: 1;
            min-width: 0;
        }

        .activity-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .activity-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        .activity-meta {
            text-align: right;
            flex-shrink: 0;
        }

        .activity-value {
            font-weight: 700;
            font-size: 14px;
        }

        .activity-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 700;
            margin-top: 4px;
        }

        .badge-hot {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .badge-warm {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .badge-cold {
            background: rgba(100, 116, 139, 0.3);
            color: var(--text-muted);
        }

        .badge-new {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info);
        }

        /* Quick Actions Bar */
        .quick-bar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            animation: fadeUp 0.6s ease 0.5s both;
        }

        .quick-action {
            flex: 1;
            min-width: 140px;
            padding: 18px;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: var(--text);
        }

        .quick-action:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 15px 30px -10px rgba(99, 102, 241, 0.3);
        }

        .quick-action-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .quick-action-text {
            font-size: 13px;
            font-weight: 600;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-size: 12px;
            animation: fadeUp 0.6s ease 0.6s both;
        }

        .footer a {
            color: var(--primary-light);
            text-decoration: none;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
    </style>
</head>

<body class="dark">
    <div class="bg-universe">
        <div class="stars"></div>
        <div class="grid-lines"></div>
        <div class="nebula n1"></div>
        <div class="nebula n2"></div>
        <div class="nebula n3"></div>
    </div>

    <div class="container">
        <!-- Brand Header -->
        <header class="brand-header">
            <div class="brand">
                <span class="brand-name">pracmatik</span>
                <span class="brand-dot">.</span>
            </div>
            <div class="header-actions">
                <div class="time-display">
                    <div class="time" id="currentTime">--:--</div>
                    <div id="currentDate">--</div>
                </div>
                <button class="icon-btn" onclick="loadAllData()" title="Actualizar">üîÑ</button>
                <button class="icon-btn" onclick="toggleTheme()" title="Tema">üåì</button>
            </div>
        </header>

        <!-- Section Overview -->
        <div class="overview-grid">
            <a href="dashboard.html" class="section-card" style="--i:0; --card-accent: var(--success);">
                <svg class="status-ring" viewBox="0 0 50 50">
                    <circle class="ring-bg" cx="25" cy="25" r="20" />
                    <circle class="ring-progress" cx="25" cy="25" r="20" stroke-dasharray="126" stroke-dashoffset="30"
                        id="ringFinanciero" />
                </svg>
                <div class="section-icon">üí∞</div>
                <div class="section-title">Finanzas</div>
                <div class="section-value" id="secIngresos">-</div>
                <div class="section-subtitle">Ingresos totales</div>
                <div class="section-mini-chart" id="miniChartFinanzas"></div>
            </a>
            <a href="clientes.html" class="section-card" style="--i:1; --card-accent: var(--info);">
                <svg class="status-ring" viewBox="0 0 50 50">
                    <circle class="ring-bg" cx="25" cy="25" r="20" />
                    <circle class="ring-progress" cx="25" cy="25" r="20" stroke-dasharray="126" stroke-dashoffset="50"
                        id="ringClientes" />
                </svg>
                <div class="section-icon">üë•</div>
                <div class="section-title">Clientes</div>
                <div class="section-value" id="secClientes">-</div>
                <div class="section-subtitle">Activos</div>
                <div class="section-mini-chart" id="miniChartClientes"></div>
            </a>
            <a href="leads.html" class="section-card" style="--i:2; --card-accent: var(--warning);">
                <svg class="status-ring" viewBox="0 0 50 50">
                    <circle class="ring-bg" cx="25" cy="25" r="20" />
                    <circle class="ring-progress" cx="25" cy="25" r="20" stroke-dasharray="126" stroke-dashoffset="60"
                        id="ringLeads" />
                </svg>
                <div class="section-icon">üéØ</div>
                <div class="section-title">Leads</div>
                <div class="section-value" id="secLeads">-</div>
                <div class="section-subtitle">En pipeline</div>
                <div class="section-mini-chart" id="miniChartLeads"></div>
            </a>
            <a href="proyectos.html" class="section-card" style="--i:3; --card-accent: var(--purple);">
                <svg class="status-ring" viewBox="0 0 50 50">
                    <circle class="ring-bg" cx="25" cy="25" r="20" />
                    <circle class="ring-progress" cx="25" cy="25" r="20" stroke-dasharray="126" stroke-dashoffset="40"
                        id="ringProyectos" />
                </svg>
                <div class="section-icon">üìã</div>
                <div class="section-title">Proyectos</div>
                <div class="section-value" id="secProyectos">-</div>
                <div class="section-subtitle">En curso</div>
                <div class="section-mini-chart" id="miniChartProyectos"></div>
            </a>
            <a href="comercial.html" class="section-card" style="--i:4; --card-accent: var(--pink);">
                <svg class="status-ring" viewBox="0 0 50 50">
                    <circle class="ring-bg" cx="25" cy="25" r="20" />
                    <circle class="ring-progress" cx="25" cy="25" r="20" stroke-dasharray="126" stroke-dashoffset="80"
                        id="ringComercial" />
                </svg>
                <div class="section-icon">üìß</div>
                <div class="section-title">Comercial</div>
                <div class="section-value" id="secComercial">-</div>
                <div class="section-subtitle">Leads calientes</div>
                <div class="section-mini-chart" id="miniChartComercial"></div>
            </a>
            <a href="index.html" class="section-card" style="--i:5; --card-accent: var(--cyan);">
                <svg class="status-ring" viewBox="0 0 50 50">
                    <circle class="ring-bg" cx="25" cy="25" r="20" />
                    <circle class="ring-progress" cx="25" cy="25" r="20" stroke-dasharray="126" stroke-dashoffset="20"
                        id="ringFacturas" />
                </svg>
                <div class="section-icon">üìù</div>
                <div class="section-title">Facturas</div>
                <div class="section-value" id="secFacturas">-</div>
                <div class="section-subtitle">Este mes</div>
                <div class="section-mini-chart" id="miniChartFacturas"></div>
            </a>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard-main">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">üìä Rendimiento</span>
                    <a href="dashboard.html" class="panel-link">Ver detalle ‚Üí</a>
                </div>
                <div class="chart-wrapper"><canvas id="mainChart"></canvas></div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">‚ö° Actividad Reciente</span>
                </div>
                <div class="activity-feed" id="activityFeed">
                    <div style="text-align:center; color: var(--text-muted); padding: 40px;">Cargando...</div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-bar">
            <a href="index.html" class="quick-action">
                <div class="quick-action-icon">üìù</div>
                <div class="quick-action-text">Nueva Factura</div>
            </a>
            <a href="clientes.html#nuevo" class="quick-action">
                <div class="quick-action-icon">üë§</div>
                <div class="quick-action-text">Nuevo Cliente</div>
            </a>
            <a href="leads.html#nuevo" class="quick-action">
                <div class="quick-action-icon">üéØ</div>
                <div class="quick-action-text">Nuevo Lead</div>
            </a>
            <a href="proyectos.html#nuevo" class="quick-action">
                <div class="quick-action-icon">üìã</div>
                <div class="quick-action-text">Nuevo Proyecto</div>
            </a>
            <a href="comercial.html" class="quick-action">
                <div class="quick-action-icon">üî•</div>
                <div class="quick-action-text">Email Tracking</div>
            </a>
        </div>

        <footer class="footer">
            <p>pracmatik. ¬© 2024 ‚Äî <a href="crm.html">Inicio</a></p>
        </footer>
    </div>

    <script>
        // Config
        const SHEETS = {
            contabilidad: '1jd6ahi9HUk1HAPDO2jby9rvC2RXNtGG0EzAeY7ijOss',
            clientes: '1X-wjUgctzNOiDu7Y7pposZqctCGZQGxbACpYkYWyIRc',
            leads: '1FH7wmTbfwbs4UtFuOP_bxV7GQAJwHTp1jG-hc-_u93w',
            proyectos: '1iUryR--UrLzW9SofHx9uaUbedATRZk-qC99xkErqCMU'
        };
        const WEBHOOK_EMAIL = 'https://hooks.pracmatik.com/webhook/email-tracking';

        // Theme
        document.body.className = localStorage.getItem('theme') || 'dark';
        function toggleTheme() {
            const t = document.body.classList.contains('dark') ? 'light' : 'dark';
            document.body.className = t;
            localStorage.setItem('theme', t);
        }

        // Clock
        function updateClock() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('currentDate').textContent = now.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Helpers
        const fmt = n => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(n);

        async function fetchSheet(sheetId, sheetName = 'Hoja 1') {
            try {
                const res = await fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`);
                const text = await res.text();
                const json = JSON.parse(text.substring(47, text.length - 2));
                const cols = json.table.cols.map(c => c.label || '');
                return json.table.rows.map(r => {
                    const obj = {};
                    r.c.forEach((cell, i) => { if (cols[i]) obj[cols[i]] = cell ? (cell.v ?? '') : ''; });
                    return obj;
                });
            } catch { return []; }
        }

        async function fetchEmailTracking() {
            try {
                const res = await fetch(WEBHOOK_EMAIL);
                if (res.ok) return await res.json();
            } catch { }
            return [];
        }

        // Render mini charts
        function renderMiniChart(id, values, color) {
            const container = document.getElementById(id);
            if (!container) return;
            const max = Math.max(...values, 1);
            container.innerHTML = values.map((v, i) =>
                `<div class="mini-bar" style="height: ${Math.max(5, v / max * 100)}%; --b: ${i}"></div>`
            ).join('');
        }

        // Main Chart
        let mainChart = null;
        function renderMainChart(ingresos, gastos) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const currentMonth = new Date().getMonth();
            const labels = months.slice(Math.max(0, currentMonth - 5), currentMonth + 1);

            const ingByMonth = new Array(12).fill(0);
            const gasByMonth = new Array(12).fill(0);

            ingresos.forEach(r => {
                const fecha = r.Fecha || '';
                if (fecha) {
                    const parts = String(fecha).split(/[\/\-]/);
                    const month = parts.length >= 2 ? parseInt(parts[1]) - 1 : 0;
                    ingByMonth[month] += parseFloat(r.Base_Imponible || 0);
                }
            });
            gastos.forEach(r => {
                const fecha = r.Fecha || '';
                if (fecha) {
                    const parts = String(fecha).split(/[\/\-]/);
                    const month = parts.length >= 2 ? parseInt(parts[1]) - 1 : 0;
                    gasByMonth[month] += parseFloat(r.Base_Imponible || 0);
                }
            });

            const dataIng = labels.map((_, i) => ingByMonth[Math.max(0, currentMonth - 5) + i] || 0);
            const dataGas = labels.map((_, i) => gasByMonth[Math.max(0, currentMonth - 5) + i] || 0);

            if (mainChart) mainChart.destroy();
            const gradient = ctx.createLinearGradient(0, 0, 0, 280);
            gradient.addColorStop(0, 'rgba(16, 185, 129, 0.3)');
            gradient.addColorStop(1, 'rgba(16, 185, 129, 0)');

            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Ingresos', data: dataIng, borderColor: '#10b981', backgroundColor: gradient, fill: true, tension: 0.4, pointRadius: 4, pointBackgroundColor: '#10b981' },
                        { label: 'Gastos', data: dataGas, borderColor: '#ef4444', backgroundColor: 'transparent', tension: 0.4, pointRadius: 4, pointBackgroundColor: '#ef4444', borderDash: [5, 5] }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'top', labels: { color: '#64748b', font: { size: 11 }, usePointStyle: true } } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#64748b' } },
                        y: { grid: { color: 'rgba(148,163,184,0.1)' }, ticks: { color: '#64748b', callback: v => fmt(v) } }
                    },
                    interaction: { intersect: false, mode: 'index' }
                }
            });

            // Mini chart finanzas
            renderMiniChart('miniChartFinanzas', dataIng, 'var(--success)');
        }

        // Activity Feed
        function renderActivity(leads, proyectos, emails) {
            const feed = document.getElementById('activityFeed');
            const items = [];

            // Recent leads
            leads.slice(-3).reverse().forEach(l => {
                items.push({
                    icon: 'üéØ', iconClass: 'warning',
                    title: l.Nombre || 'Lead',
                    desc: l.Origen || 'Nuevo lead',
                    value: l.Valor_Estimado ? fmt(l.Valor_Estimado) : '',
                    badge: 'NUEVO', badgeClass: 'badge-new'
                });
            });

            // Hot emails
            const hotEmails = (emails || []).filter(e => e.interes === 'hot').slice(0, 3);
            hotEmails.forEach(e => {
                items.push({
                    icon: 'üî•', iconClass: 'success',
                    title: e.empresa || 'Empresa',
                    desc: `${e.aperturas || 0} aperturas`,
                    value: e.email || '',
                    badge: 'CALIENTE', badgeClass: 'badge-hot'
                });
            });

            // Recent projects
            proyectos.slice(-2).reverse().forEach(p => {
                items.push({
                    icon: 'üìã', iconClass: 'purple',
                    title: p.Nombre || 'Proyecto',
                    desc: p.Fase || 'En curso',
                    value: p.Precio ? fmt(p.Precio) : '',
                    badge: p.Fase || '', badgeClass: 'badge-new'
                });
            });

            if (items.length === 0) {
                feed.innerHTML = '<div style="text-align:center; color: var(--text-muted); padding: 40px;">No hay actividad reciente</div>';
                return;
            }

            feed.innerHTML = items.slice(0, 8).map((item, i) => `
        <div class="activity-item" style="--i: ${i}">
          <div class="activity-icon ${item.iconClass}">${item.icon}</div>
          <div class="activity-content">
            <div class="activity-title">${item.title}</div>
            <div class="activity-desc">${item.desc}</div>
          </div>
          <div class="activity-meta">
            ${item.value ? `<div class="activity-value">${item.value}</div>` : ''}
            <span class="activity-badge ${item.badgeClass}">${item.badge}</span>
          </div>
        </div>
      `).join('');
        }

        // Update ring progress
        function updateRing(id, percentage) {
            const ring = document.getElementById(id);
            if (ring) {
                const offset = 126 - (126 * Math.min(100, percentage) / 100);
                ring.style.strokeDashoffset = offset;
            }
        }

        // Load All Data
        async function loadAllData() {
            try {
                const [ingresos, gastos, clientes, leads, proyectos, emails] = await Promise.all([
                    fetchSheet(SHEETS.contabilidad, 'Ingresos'),
                    fetchSheet(SHEETS.contabilidad, 'Gastos'),
                    fetchSheet(SHEETS.clientes),
                    fetchSheet(SHEETS.leads),
                    fetchSheet(SHEETS.proyectos),
                    fetchEmailTracking()
                ]);

                // Calculate KPIs
                const totalIngresos = ingresos.reduce((s, r) => s + (parseFloat(r.Base_Imponible) || 0), 0);
                const totalGastos = gastos.reduce((s, r) => s + (parseFloat(r.Base_Imponible) || 0), 0);
                const clientesActivos = clientes.length;
                const leadsActivos = leads.filter(l => !['GANADO', 'PERDIDO'].includes(l.Estado)).length;
                const proyectosActivos = proyectos.filter(p => p.Fase !== 'COMPLETADO').length;

                // New hot calculation: >8 opens OR (recent open <7 days if sent >15 days ago)
                const now = new Date();
                const hotEmails = (emails || []).filter(e => {
                    const opens = parseInt(e.aperturas || 0);
                    if (opens >= 8) return true;

                    const lastOpen = e.ultima ? parseDate(e.ultima) : null;
                    const sentDate = e.enviado ? parseDate(e.enviado) : null;

                    if (lastOpen && sentDate) {
                        const daysSinceOpen = Math.floor((now - lastOpen) / (1000 * 60 * 60 * 24));
                        const daysSinceSent = Math.floor((now - sentDate) / (1000 * 60 * 60 * 24));
                        if (daysSinceOpen <= 7 && daysSinceSent > 15) return true;
                    }
                    return false;
                });

                const thisMonth = new Date().getMonth();
                const facturasEste = ingresos.filter(r => {
                    const fecha = r.Fecha || '';
                    if (fecha) {
                        const parts = String(fecha).split(/[\/\-]/);
                        const month = parts.length >= 2 ? parseInt(parts[1]) - 1 : -1;
                        return month === thisMonth;
                    }
                    return false;
                }).length;

                // Update section cards
                document.getElementById('secIngresos').textContent = fmt(totalIngresos);
                document.getElementById('secClientes').textContent = clientesActivos;
                document.getElementById('secLeads').textContent = leadsActivos;
                document.getElementById('secProyectos').textContent = proyectosActivos;
                document.getElementById('secComercial').textContent = hotEmails.length;
                document.getElementById('secFacturas').textContent = facturasEste;

                // Update rings (based on arbitrary goals for visual effect)
                updateRing('ringFinanciero', Math.min(100, totalIngresos / 50000 * 100));
                updateRing('ringClientes', Math.min(100, clientesActivos / 20 * 100));
                updateRing('ringLeads', Math.min(100, leadsActivos / 15 * 100));
                updateRing('ringProyectos', Math.min(100, proyectosActivos / 10 * 100));
                updateRing('ringComercial', Math.min(100, hotEmails.length / 10 * 100));
                updateRing('ringFacturas', Math.min(100, facturasEste / 10 * 100));

                // Render charts
                renderMainChart(ingresos, gastos);

                // Mini charts
                renderMiniChart('miniChartClientes', [3, 5, 4, 7, clientesActivos, clientesActivos + 2], 'var(--info)');
                const leadsByState = { NUEVO: 0, CONTACTADO: 0, PROPUESTA: 0, NEGOCIANDO: 0, GANADO: 0 };
                leads.forEach(l => { if (leadsByState.hasOwnProperty(l.Estado)) leadsByState[l.Estado]++; });
                renderMiniChart('miniChartLeads', Object.values(leadsByState), 'var(--warning)');
                const projByPhase = { INICIO: 0, DESARROLLO: 0, REVISION: 0, ENTREGA: 0, COMPLETADO: 0 };
                proyectos.forEach(p => { if (projByPhase.hasOwnProperty(p.Fase)) projByPhase[p.Fase]++; });
                renderMiniChart('miniChartProyectos', Object.values(projByPhase), 'var(--purple)');
                renderMiniChart('miniChartComercial', [2, 4, 3, 6, hotEmails.length, hotEmails.length + 1], 'var(--pink)');
                renderMiniChart('miniChartFacturas', [2, 3, 4, 2, facturasEste, 3], 'var(--cyan)');

                // Activity
                renderActivity(leads, proyectos, emails);

            } catch (e) { console.error('Error:', e); }
        }

        function parseDate(str) {
            if (!str) return null;
            try {
                if (String(str).includes('/')) {
                    const parts = String(str).split(/[\/\s:]/);
                    if (parts.length >= 3) return new Date(parts[2], parts[1] - 1, parts[0]);
                }
                return new Date(str);
            } catch { return null; }
        }

        // Init
        loadAllData();
    </script>
</body>

</html>